<odoo>
    <data>
        <record id="rule_pph21_ptkp" model="hr.salary.rule">
            <field name="name">x_Penghasilan Tidak Kena Pajak</field>
            <field name="category_id" ref="hr_payroll_community.DED"/>
            <field name="code">PTKP</field>
            <field name="sequence">200</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">result=employee.ptkp_id.nominal</field>
        </record>

        <record id="rule_pph21_disetahunkan" model="hr.salary.rule">
            <field name="name">x_Penghasilan Disetahunkan</field>
            <field name="category_id" ref="hr_payroll_community.DED"/>
            <field name="code">PSTH</field>
            <field name="sequence">210</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">result=(contract.wage+contract.x_trans+contract.x_occup+contract.x_family+contract.x_functional+contract.x_perform)*12</field>
        </record>

        <record id="rule_pph21_biayajabatan" model="hr.salary.rule">
            <field name="name">x_Biaya Jabatan</field>
            <field name="category_id" ref="hr_payroll_community.DED"/>
            <field name="code">BJAB</field>
            <field name="sequence">220</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">result= min(0.05 * PSTH , 6000000)</field>
        </record>

        <record id="rule_pph21_netto" model="hr.salary.rule">
            <field name="name">x_Netto</field>
            <field name="category_id" ref="hr_payroll_community.DED"/>
            <field name="code">NETTO</field>
            <field name="sequence">230</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">result= PSTH-BJAB-(contract.wage+contract.x_tpk+contract.x_occup+contract.x_trans+contract.x_family+contract.x_presence+contract.x_functional)*0.02*12</field>
        </record>

        <record id="rule_pph21_pkp" model="hr.salary.rule">
            <field name="name">x_Pendapatan Kena Pajak</field>
            <field name="category_id" ref="hr_payroll_community.DED"/>
            <field name="code">PKP</field>
            <field name="sequence">240</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">result=NETTO-PTKP if NETTO-PTKP>0 else 0</field>
        </record>

        <record id="rule_pph21_setahun" model="hr.salary.rule">
            <field name="name">x_PPh21 Setahun</field>
            <field name="category_id" ref="hr_payroll_community.DED"/>
            <field name="code">PPH21</field>
            <field name="sequence">250</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute"><![CDATA[
sisa_pkp = PKP 
pph21 = 0 
range = contract.company_id.pkp_ids[0]
if PKP > range.maximum:
    sisa_pkp = PKP - range.maximum   # 145-50 = 95
    pph21 += range.maximum * range.rate / 100 # 50*5%
if sisa_pkp > 0:
    range = contract.company_id.pkp_ids[1]
    if sisa_pkp < (range.maximum-range.minimum+1):
        pph21 += sisa_pkp * range.rate / 100 # sisa_pkp * 15%
    else:
        pph21 += range.maximum * range.rate /100 # range.maximum *15%
        sisa_pkp = sisa_pkp - (range.maximum-range,minimun+1)
        if sisa_pkp > 0:
            range = contract.company_id.pkp_ids[2]
            if sisa_pkp < (range.maximum-range.minimum+1):
                pph21 += sisa_pkp * range.rate / 100 # sisa_pkp * 25%
            else:
                pph21 += range.maximum * range.rate /100 # range.maximum *25%
                sisa_pkp = sisa_pkp - (range.maximum-range,minimun+1)
                if sisa_pkp > 0:
                    range = contract.company_id.pkp_ids[3]
                    pph21 += sisa_pkp * range.rate / 100 # sisa_pkp * 30%
result = pph21
]]>
            </field>
        </record>

        <record id="aag_add_field.structurexacti_karyawan_tetap_ns" model="hr.payroll.structure">
            <field name="name">x_Karyawan Tetap NS</field>
            <field name="parent_id" ref="hr_payroll_community.structure_base"/>
            <field name="code">KTNS</field>
            <field name="rule_ids" eval="[(4,ref('rule_pph21_ptkp')),
             (4,ref('rule_pph21_disetahunkan')),
             (4,ref('rule_pph21_biayajabatan')),
             (4,ref('rule_pph21_netto')),
             (4,ref('rule_pph21_pkp')),
             (4,ref('rule_pph21_setahun'))
             ]"/>
        </record>

    </data>
</odoo>